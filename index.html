<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Delhi Road Data Dashboard</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #1a1a1a;
            color: white;
            overflow: hidden;
        }
        
        #container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .controls {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            background: #6b7280;
            color: white;
            cursor: pointer;
            font-weight: 500;
            transition: background-color 0.2s;
        }
        
        .btn.active {
            background: #2563eb;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .panel {
            position: absolute;
            top: 80px;
            left: 20px;
            z-index: 1000;
            background: rgba(40, 40, 40, 0.95);
            padding: 16px;
            border-radius: 8px;
            width: 200px;
            border: 1px solid rgba(60, 60, 60, 0.8);
        }
        
        .date-select {
            width: 100%;
            padding: 8px;
            border: 1px solid #4b5563;
            border-radius: 4px;
            background: #374151;
            color: white;
            margin-bottom: 20px;
        }
        
        .legend {
            margin-bottom: 20px;
        }
        
        .legend-bar {
            display: flex;
            height: 16px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 6px;
            width: 100%;
        }
        
        .legend-labels {
            display: flex;
            justify-content: space-between;
            font-size: 9px;
            color: #ccc;
            padding: 0 8%;
        }
        
        .mesh-legend {
            display: flex;
            justify-content: center;
            gap: 12px;
            margin-bottom: 6px;
        }
        
        .mesh-item {
            text-align: center;
        }
        
        .mesh-color {
            width: 20px;
            height: 20px;
            border: 1px solid rgba(255,255,255,0.3);
            margin-bottom: 3px;
            border-radius: 2px;
        }
        
        .mesh-label {
            font-size: 9px;
            color: #ccc;
            white-space: nowrap;
        }
        
        .description {
            padding: 12px;
            background: rgba(60, 60, 60, 0.8);
            border-radius: 6px;
            font-size: 11px;
            line-height: 1.4;
            color: #ccc;
        }
        
        .description strong {
            color: #fff;
        }
        
        .loading {
            text-align: center;
            margin-top: 16px;
            color: #6b7280;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="map"></div>
        
        <div class="controls">
            <button class="btn active" id="btn-roughness">Road Roughness</button>
            <button class="btn" id="btn-traffic">Traffic Volume</button>
            <button class="btn" id="btn-decel">Hard Braking</button>
        </div>
        
        <div class="panel">
            <select class="date-select" id="date-select">
                <option value="2507">July 2025</option>
                <option value="2508">August 2025</option>
                <option value="2509">September 2025</option>
            </select>
            
            <div class="legend" id="legend">
                <!-- 動的に生成 -->
            </div>
            
            <div class="description" id="description">
                <strong>Road Roughness Index</strong><br>
                Calculated from Honda production vehicle data. Higher values indicate worse road conditions. Useful for prioritizing road maintenance.
            </div>
            
            <div class="loading" id="loading" style="display: none;">
                Loading...
            </div>
        </div>
    </div>

    <!-- 外部ライブラリ -->
    <script src="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@3.6.2/dist/maplibre-gl.css" rel="stylesheet">
    <script src="https://unpkg.com/deck.gl@8.9.0/dist.min.js"></script>

    <script>
        // グローバル変数
        let map;
        let deckgl;
        let currentDataType = 'roughness';
        let currentData = null;
        
        // 色設定
        const COLOR_SCALE = [
            [255, 255, 100, 180],    // 黄色
            [255, 140, 0, 220],      // オレンジ
            [255, 50, 50, 255]       // 赤
        ];
        
        // データタイプごとの閾値
        const THRESHOLDS = {
            roughness: [2293, 4822],
            traffic: [47, 404],
            decel: [5, 10]
        };
        
        // 説明文
        const DESCRIPTIONS = {
            roughness: '<strong>Road Roughness Index</strong><br>Calculated from Honda production vehicle data. Higher values indicate worse road conditions.',
            traffic: '<strong>Traffic Volume Index</strong><br>Predictive traffic volume calculated from Honda production vehicle data.',
            decel: '<strong>Hard Braking Location</strong><br>Based on hard braking events from Honda production vehicles. Higher values may indicate safety concerns.'
        };
        
        // 色を取得する関数
        function getColor(value, dataType) {
            const thresholds = THRESHOLDS[dataType];
            if (value >= thresholds[1]) return COLOR_SCALE[2];
            if (value >= thresholds[0]) return COLOR_SCALE[1];
            return COLOR_SCALE[0];
        }
        
        // 凡例を更新
        function updateLegend() {
            const legend = document.getElementById('legend');
            
            if (currentDataType === 'decel') {
                // メッシュ凡例
                legend.innerHTML = `
                    <div class="mesh-legend">
                        <div class="mesh-item">
                            <div class="mesh-color" style="background-color: rgba(${COLOR_SCALE[0].join(',')})"></div>
                            <div class="mesh-label">3-5</div>
                        </div>
                        <div class="mesh-item">
                            <div class="mesh-color" style="background-color: rgba(${COLOR_SCALE[1].join(',')})"></div>
                            <div class="mesh-label">5-9</div>
                        </div>
                        <div class="mesh-item">
                            <div class="mesh-color" style="background-color: rgba(${COLOR_SCALE[2].join(',')})"></div>
                            <div class="mesh-label">10+</div>
                        </div>
                    </div>
                `;
            } else {
                // バー凡例
                    legend.innerHTML = `
                        <div class="legend-bar">
                            <div style="flex: 1; background-color: rgba(${COLOR_SCALE[0].join(',')})"></div>
                            <div style="flex: 1; background-color: rgba(${COLOR_SCALE[1].join(',')})"></div>
                            <div style="flex: 1; background-color: rgba(${COLOR_SCALE[2].join(',')})"></div>
                        </div>
                        <div class="legend-labels" style="width: 100%; display: flex;">
                            <div style="flex:1; text-align:center; margin-left:-15px;">
                                Low<br><span style='font-size:10px;'>(0–50%)</span>
                            </div>
                            <div style="flex:1; text-align:center;">
                                Medium<br><span style='font-size:10px;'>(50–80%)</span>
                            </div>
                            <div style="flex:1; text-align:center; margin-right:-15px;">
                                High<br><span style='font-size:10px;'>(80–100%)</span>
                            </div>
                        </div>
                    `;
            }
        }
        
        // データを読み込む
        async function loadData(dataType, dateCode = null) {
            const loading = document.getElementById('loading');
            loading.style.display = 'block';
            
            try {
                // 日付コードが指定されていない場合は現在の選択値を使用
                if (!dateCode) {
                    dateCode = document.getElementById('date-select').value;
                }
                
                let filename;
                switch (dataType) {
                    case 'roughness':
                        filename = `roughness_delhi_${dateCode}.geojson`;
                        break;
                    case 'traffic':
                        filename = `traffic_delhi_${dateCode}.geojson`;
                        break;
                    case 'decel':
                        filename = 'decel_delhi_2509.geojson';
                        break;
                }
                
                const response = await fetch(`./geojson/${filename}`);
                if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
                currentData = await response.json();
                updateVisualization();
                
            } catch (error) {
                console.error('Error loading data:', error);
                console.error('Attempted to load:', `./geojson/${filename}`);
                alert(`データの読み込みに失敗しました。\nファイル: ${filename}\nエラー: ${error.message}`);
            } finally {
                loading.style.display = 'none';
            }
        }
        
        // 可視化を更新
        function updateVisualization() {
            if (!currentData || !deckgl) return;
            
            let layers = [];
            
            if (currentDataType === 'decel') {
                // 急減速データ用のポリゴンレイヤー
                const meshData = currentData.features.map(feature => {
                    const lon = feature.properties.lon;
                    const lat = feature.properties.lat;
                    const halfSize = 0.00005;
                    
                    return {
                        type: 'Feature',
                        properties: feature.properties,
                        geometry: {
                            type: 'Polygon',
                            coordinates: [[
                                [lon - halfSize, lat - halfSize],
                                [lon + halfSize, lat - halfSize],
                                [lon + halfSize, lat + halfSize],
                                [lon - halfSize, lat + halfSize],
                                [lon - halfSize, lat - halfSize]
                            ]]
                        }
                    };
                });
                
                layers.push(new deck.GeoJsonLayer({
                    id: 'decel-layer',
                    data: { type: 'FeatureCollection', features: meshData },
                    getFillColor: d => getColor(d.properties.dcl_cnt, 'decel'),
                    getLineColor: [0, 0, 0, 0],
                    pickable: true
                }));
            } else {
                // 道路データ用のラインレイヤー
                layers.push(new deck.GeoJsonLayer({
                    id: 'road-layer',
                    data: currentData,
                    getLineColor: d => {
                        const value = currentDataType === 'roughness' ? d.properties.rsm : d.properties.tv;
                        return getColor(value, currentDataType);
                    },
                    getLineWidth: 8,
                    pickable: true
                }));
            }
            
            deckgl.setProps({ layers });
        }
        
        // データタイプを変更
        function changeDataType(newType) {
            currentDataType = newType;
            
            // ボタンの状態を更新
            document.querySelectorAll('.btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`btn-${newType}`).classList.add('active');
            
            // 日付選択を更新
            const dateSelect = document.getElementById('date-select');
            if (newType === 'decel') {
                dateSelect.innerHTML = '<option value="2509">September 2025</option>';
            } else {
                dateSelect.innerHTML = `
                    <option value="2507">July 2025</option>
                    <option value="2508">August 2025</option>
                    <option value="2509">September 2025</option>
                `;
            }
            
            // 説明を更新
            document.getElementById('description').innerHTML = DESCRIPTIONS[newType];
            
            // 凡例を更新
            updateLegend();
            
            // データを読み込み
            loadData(newType);
        }
        
        // 初期化
        function init() {
            // 地図を初期化
            map = new maplibregl.Map({
                container: 'map',
                style: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                center: [77.1965, 28.5816], // デリーの中心
                zoom: 10
            });
            
            // deck.glを初期化
            deckgl = new deck.DeckGL({
                container: 'map',
                map: maplibregl,
                mapStyle: 'https://basemaps.cartocdn.com/gl/dark-matter-gl-style/style.json',
                initialViewState: {
                    longitude: 77.1965,
                    latitude: 28.5816,
                    zoom: 10,
                    pitch: 0,
                    bearing: 0
                },
                controller: true,
                layers: []
            });
            
            // イベントリスナーを設定
            document.getElementById('btn-roughness').addEventListener('click', () => changeDataType('roughness'));
            document.getElementById('btn-traffic').addEventListener('click', () => changeDataType('traffic'));
            document.getElementById('btn-decel').addEventListener('click', () => changeDataType('decel'));
            
            // 日付選択のイベントリスナーを追加
            document.getElementById('date-select').addEventListener('change', (e) => {
                loadData(currentDataType, e.target.value);
            });
            
            // 初期設定
            updateLegend();
            loadData('roughness');
        }
        
        // ページ読み込み完了後に初期化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>